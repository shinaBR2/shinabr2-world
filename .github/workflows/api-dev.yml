name: Dev - Deploy API
'on':
  push:
    branches:
      - api-dev
      - deploy-cloud-functions-again
    paths:
      - 'apps/api/**'
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
    # env:
    # SLACK_WEBHOOK_URL: '${{ secrets.SLACK_NOTIFICATION_WEBHOOK }}'
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: install_node
        name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.17.0

      - id: setup_pnpm
        name: Setup pnpm
        uses: pnpm/action-setup@v4.0.0
        with:
          run_install: true

      - id: install_packages
        name: Install packages
        run: pnpm install --filter api

      - name: Copy firebase.json file
        run: cp firebase.json apps/api/firebase.json

      - id: build
        name: Build
        env:
          NODE_ENV: production
        run: pnpm build --filter api

      - id: deploy
        name: Deploy
        uses: w9jds/firebase-action@master
        with:
          args: >
            use my-world-dev
            && firebase deploy --only functions
        env:
          GCP_SA_KEY: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MY_WORLD_DEV }}'
          PROJECT_ID: my-world-dev
